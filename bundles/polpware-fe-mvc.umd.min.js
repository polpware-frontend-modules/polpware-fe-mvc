!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("rxjs"),require("rxjs/operators"),require("@polpware/fe-utilities"),require("@polpware/fe-dependencies")):"function"==typeof define&&define.amd?define("@polpware/fe-mvc",["exports","rxjs","rxjs/operators","@polpware/fe-utilities","@polpware/fe-dependencies"],t):t((e.polpware=e.polpware||{},e.polpware["fe-mvc"]={}),e.rxjs,e.rxjs.operators,e.feUtilities,e.dependencies)}(this,function(e,n,i,s,t){"use strict";var a=t.underscore.noop,r={$data:{init:a,setRefreshCallback:a,setInfiniteCallback:a,clean:a,asyncPush:a,syncPush:a,asyncPop:a,syncPop:a,asyncPrepend:a,syncPrepend:a,asyncRefresh:a,syncRefresh:a,hasMoreData:a,getItems:a,setupSearch:a,updateSearchCriteria:a,getAncestor:a},$loader:{show:a,hide:a},$refresher:{show:a,hide:a},$moreLoader:{show:a,hide:a},$router:{go:a},$render:{ready:a,destroy:a,asyncDigest:a},$navBar:{getState:a,setState:a},$modal:{setData:a,getData:a,build:a},$popover:{setData:a,getData:a,build:a,onHidden:a},$popup:{setData:a,getData:a,build:a,confirm:a,prompt:a,alert:a},$progressBar:{create:a,reset:a,createInfinite:a,onProgress:a,destroy:a,destroyInfinite:a,showAbort:a},$alertify:a,$history:{goBack:a}},o=t.Class,d=t.underscore,l=o.extend({Properties:"dataProvider,dataParams,deepCopy,useModel,enableRefresh,enableInfinite,onUpdateView,viewInstance",init:function(e){var t=this;t._settings=e,t._viewInstance=r,t._dataProvider=e.dataProvider||null,t._dataParams=e.dataParams||{},t._deepCopy=e.deepCopy||!1,t._useModel=e.useModel||!1,t._enableRefresh=e.enableRefresh||!1,t._enableInfinite=e.enableInfinite||!1,t._stateContext={},t._isInit=!0,t._isLoadingData=!1},generateItemsInternal:function(e){var t=[];return this._useModel?e.forEach(function(e){t.push(e)}):this._deepCopy?e.forEach(function(e){t.push(d.extend({},e.attributes))}):e.forEach(function(e){t.push(e.attributes)}),t},safelyReadDataProvider:function(){var t,e=this;return e._dataProvider.models?t=e._dataProvider.models:(t=[],e._dataProvider.forEach(function(e){t.push(e)})),t},generateItems:function(e){var t=this,a=t._viewInstance.$data,r=t.safelyReadDataProvider(),n=t.generateItemsInternal(r);!0===e?(t.onUpdateView({add:!0,source:"remote",data:n}),a.asyncPush(n)):(t.onUpdateView({add:!0,source:"cache",data:n}),a.syncPush(n))},loadInitData:function(){var t=this,a=t._dataProvider;a.reset(),t._isLoadingData=!0;var e=t._dataParams,r=a.getFirstPage({data:d.extend({},e)});return(r=s.tojQueryDeferred(r)).always(function(){t._isInit=!1,t._isLoadingData=!1}),r.then(function(){var e=t._viewInstance.$data;e.clean(),e.hasMoreData(a.hasNextPage()),t.generateItems(!0)})},renderData:function(e){var t=this,a=t._viewInstance.$data;a.clean(),a.hasMoreData(t._dataProvider.hasNextPage()),t.generateItems(!0===e)},refresh:function(e){var t=this,a=t._viewInstance.$data,r=t._viewInstance.$refresher;a.hasMoreData(!0),r.show(e);var n=t.loadInitData();return s.tojQueryDeferred(n).always(function(){r.hide(e)})},loadMore:function(){var e=this,t=e._dataProvider,a=e._dataParams,r=e._viewInstance.$data,n=e._viewInstance.$moreLoader;if(e._isInit)return n.hide(),s.lift(!0,null);if(e._isLoadingData)return s.lift(!0,null);if(!t.hasNextPage())return r.hasMoreData(!1),n.hide(),s.lift(!0,null);n.show(),e._isLoadingData=!0;var i=t.getNextPage({data:d.extend({},a)}).then(function(){r.hasMoreData(t.hasNextPage()),e.generateItems(!0),e._isLoadingData=!1},function(){e._isLoadingData=!1});return s.tojQueryDeferred(i).always(function(){n.hide()})},stateChanged:function(){var e=this._stateContext;return!0!==e.enableSearch||e.searchModel.isConfirmed()&&e.searchModel.hashCode()!==e.searchCriteria.hashCode},updateStateAndReload:function(){var e=this,t=e._stateContext,a=e._viewInstance.$data,r=e._viewInstance.$loader;!0===t.enableSearch&&(t.searchCriteria=t.searchModel.generateFilter(),e.dataParams(t.searchCriteria.filter),a.updateSearchCriteria(t.searchCriteria)),r.show();var n=e.loadInitData();s.tojQueryDeferred(n).always(function(){r.hide()})},setUp:function(e){var t=this;if((e=e||{}).enableSearch){t._stateContext.enableSearch=!0;var a=e.searchSettings;t._stateContext.searchURL=a.searchURL,t._stateContext.searchModelGuid=a.searchModelGuid,t._stateContext.searchModel=a.searchModel,t._stateContext.searchCriteria=a.searchModel.generateFilter(),t.dataParams(t._stateContext.searchCriteria.filter)}},tearDown:function(){this._dataProvider&&this._dataProvider.off&&(this._dataProvider.off("all"),this._dataProvider.reset())},attachView:function(e){var t=this;t._viewInstance=e;var a=t._viewInstance.$data;t._enableRefresh&&a.setRefreshCallback(function(){t.refresh()}),t._enableInfinite&&a.setInfiniteCallback(function(){t.loadMore()}),t._stateContext.enableSearch&&a.setupSearch(t._stateContext.searchCriteria,function(){t._viewInstance.$router.go(t._stateContext.searchURL,{dataId:t._stateContext.searchModelGuid})}),a.init()},detachView:function(){this._viewInstance=r},_defaultStartService:function(){var e=this._viewInstance.$loader;e.show();var t=this.loadInitData();s.tojQueryDeferred(t).always(function(){e.hide()})},startServiceImpl:function(){this._defaultStartService()},startService:function(e,t){this.attachView(e),!0===t?this.renderData():this.startServiceImpl()},stopService:function(){this.detachView()}}),c=l.extend({init:function(e){this._super(e),this._ngStore=null},setNgStore:function(e){this._ngStore=e},getNgStore:function(){return this._ngStore},safelyReadDataProvider:function(){var e=this._super();return this._ngStore.add(e),e},renderData:function(a){var r=this,n=r._viewInstance.$data;n.clean(),n.hasMoreData(r._dataProvider.hasNextPage());var i=r._ngStore.getState().subscribe(function(e){var t=r.generateItemsInternal(e.items);!0===a?n.asyncPush(t):n.syncPush(t),setTimeout(function(){i.unsubscribe()},1)})}}),h=t.underscore,u=t.backbone,v=l.extend({Properties:"viewLevelData,globalProvider",init:function(e){var t=this;t._super(e);var a=u.Collection.extend();t._viewLevelData=new a,t._viewProviderListeners={},t._globalProvider=e.globalProvider||null,t._globalProviderListeners={},t._filterFlags=e.filterFlags||{added:!0,removed:!0,updated:!0}},globalProviderFilter:function(e,t,a){return this._filterFlags.added&&t.changes.added&&0<t.changes.added.length?t:this._filterFlags.removed&&t.changes.removed&&0<t.changes.removed.length?t:this._filterFlags.updated&&t.changes.merged&&0<t.changes.merged.length?t:null},findAtIndex:function(e){return-1},onGlobalProviderUpdate:function(){var r=this,e=arguments;if(!r._isLoadingData){var t=r.globalProviderFilter.apply(r,e);if(t){if(t.add){var a=h.filter(t.changes.added,function(t){return!h.some(r._viewLevelData.models,function(e){return t.id===e.id})});0<a.length&&h.each(a,function(e,t){var a=r.findAtIndex(e);-1!==a?r._viewLevelData.add(e,{at:a}):r._viewLevelData.add(e)})}t.remove&&r._viewLevelData.remove(t.changes.removed),t.merge&&r._viewLevelData.trigger("update",t.changes)}}},onViewProviderUpdate:function(e,t,a){var r,n=this,i=n._viewInstance.$data;t.changes.added&&0<t.changes.added.length&&(r=n.generateItemsInternal(t.changes.added),n.onUpdateView({add:!0,source:"event",data:r}),i.asyncPrepend(r)),t.changes.removed&&0<t.changes.removed.length&&(r=n.generateItemsInternal(t.changes.removed),n.onUpdateView({remove:!0,source:"event",data:r}),i.asyncPop(r)),t.changes.merged&&0<t.changes.merged.length&&(r=n.generateItemsInternal(t.changes.merged),n.onUpdateView({merge:!0,source:"event",data:r}),i.asyncRefresh(r))},loadInitData:function(){return this._viewLevelData.reset(),this._super()},startListeningGlobalProvider:function(e){var t=this,a=function(){var e=arguments;h.defer(function(){t.onGlobalProviderUpdate.apply(t,e)})};t._globalProviderListeners={update:a},(t._globalProvider=e).on("update",a)},stopListeningGlobalProvider:function(){var e=this._globalProviderListeners,t=this._globalProvider;for(var a in e)e.hasOwnProperty(a)&&t.off(a,e[a])},startListeningViewProvider:function(){var r=this,e=function(e,t,a){r.onViewProviderUpdate(e,t,a)};r._viewProviderListeners={update:e},r._viewLevelData.on("update",e)},stopListeningViewProvider:function(){var e=this._viewProviderListeners;for(var t in e)e.hasOwnProperty(t)&&this._viewLevelData.off(t,e[t])},safelyReadDataProvider:function(){var e=this,t=e._super();return t=h.filter(t,function(t){return!h.some(e._viewLevelData.models,function(e){return e.id===t.id})}),e._viewLevelData.add(t,{silent:!0}),t},renderData:function(e){var t=this._viewInstance.$data;t.clean(),t.hasMoreData(this._dataProvider.hasNextPage());var a=this.generateItemsInternal(this._viewLevelData.models);!0===e?t.asyncPush(a):t.syncPush(a)},setUp:function(e){this._super(e),this._globalProvider&&this.startListeningGlobalProvider(this._globalProvider)},tearDown:function(){var e=this;e._super(),e._viewLevelData.off("all"),e._viewLevelData.reset(),e._globalProvider&&e.stopListeningGlobalProvider()},attachView:function(e){this._super(e),this.startListeningViewProvider()},detachView:function(){this._super(),this.stopListeningViewProvider()}});var f=v.extend({Properties:"globalSubr, emitEventDelay",init:function(e){this._super(e),this._globalSubr=null,this._emitEventDelay=1e3},startListeningGlobalProvider:function(e){var t=this;t._globalProvider=e;var a=n.fromEvent(e,"update"),r=a.pipe(i.debounceTime(t._emitEventDelay));t._globalSubr=a.pipe(i.buffer(r),i.map(function(e){return function t(e){var a={add:!1,remove:!1,merge:!1,changes:{added:[],removed:[],merged:[]}};return e.forEach(function(e){var t=e[1];t.changes.added&&0<t.changes.added.length&&(s.pushArray(a.changes.added,t.changes.added),a.add=!0),t.changes.removed&&0<t.changes.removed.length&&(s.pushArray(a.changes.removed,t.changes.removed),a.remove=!0),t.changes.merged&&0<t.changes.merged.length&&(s.pushArray(a.changes.merged,t.changes.merged),a.merge=!0)}),a}(e)})).subscribe(function(e){t.onGlobalProviderUpdate.apply(t,[null,e])})},stopListeningGlobalProvider:function(){this._globalProvider;this._globalSubr&&(this._globalSubr.unsubscribe(),this._globalSubr=null)}}),g=t.Class.extend({Defaults:{MediatorCtor:null},Properties:"mediator,settings",init:function(e){var t=this;t._settings=e,t._isFirstTimeRendered=!0,t._mediator=e.mediator||null,t._mediatorFromCache=!!t._mediator},initMediator:function(){var e,t,a;return(e=this)._mediator||(t=e._settings,a=new e.Defaults.MediatorCtor(t),e.setupMediator(a),e._mediator=a),e},setupMediator:function(e){e.setUp()},start:function(){var e,t,a;t=(e=this)._settings,a=e._mediator,t.$render.destroy(function(){a.stopService()}),t.$render.ready(function(){e._isFirstTimeRendered&&(e._isFirstTimeRendered=!1,a.startService(t,e._mediatorFromCache))})}});e.ListMediator=l,e.noopViewInstance=r,e.NgStoreListMediator=c,e.WritableListMediator=v,e.RxjsPoweredWritableListMediator=f,e.ListControllerCtor=g,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=polpware-fe-mvc.umd.min.js.map