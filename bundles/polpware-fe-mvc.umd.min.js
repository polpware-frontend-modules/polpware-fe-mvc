!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@polpware/fe-dependencies"),require("@polpware/fe-utilities"),require("rxjs"),require("rxjs/operators")):"function"==typeof define&&define.amd?define("@polpware/fe-mvc",["exports","@polpware/fe-dependencies","@polpware/fe-utilities","rxjs","rxjs/operators"],t):t(((e=e||self).polpware=e.polpware||{},e.polpware["fe-mvc"]={}),e.feDependencies,e.feUtilities,e.rxjs,e.rxjs.operators)}(this,(function(e,t,a,r,i){"use strict";var n=t.underscore.noop,s={$data:{init:n,setRefreshCallback:n,setInfiniteCallback:n,clean:n,asyncPush:n,syncPush:n,asyncPop:n,syncPop:n,asyncPrepend:n,syncPrepend:n,asyncRefresh:n,syncRefresh:n,hasMoreData:n,getItems:n,setupSearch:n,updateSearchCriteria:n,getAncestor:n},$loader:{show:n,hide:n},$refresher:{show:n,hide:n},$moreLoader:{show:n,hide:n},$router:{go:n},$render:{ready:n,destroy:n,asyncDigest:n},$navBar:{getState:n,setState:n},$modal:{setData:n,getData:n,build:n},$popover:{setData:n,getData:n,build:n,onHidden:n},$popup:{setData:n,getData:n,build:n,confirm:n,prompt:n,alert:n},$progressBar:{create:n,reset:n,createInfinite:n,onProgress:n,destroy:n,destroyInfinite:n,showAbort:n},$alertify:n,$history:{goBack:n}},o=t.Class,d=t.underscore,h=o.extend({Properties:"dataProvider,dataParams,deepCopy,useModel,enableRefresh,enableInfinite,onUpdateView,viewInstance",init:function(e){this._settings=e,this._viewInstance=s,this._dataProvider=e.dataProvider||null,this._dataParams=e.dataParams||{},this._deepCopy=e.deepCopy||!1,this._useModel=e.useModel||!1,this._enableRefresh=e.enableRefresh||!1,this._enableInfinite=e.enableInfinite||!1,this._stateContext={},this._isInit=!0,this._isLoadingData=!1},generateItemsInternal:function(e){var t=[];return this._useModel?e.forEach((function(e){t.push(e)})):this._deepCopy?e.forEach((function(e){t.push(d.extend({},e.attributes))})):e.forEach((function(e){t.push(e.attributes)})),t},safelyReadDataProvider:function(){var e;return this._dataProvider.models?e=this._dataProvider.models:(e=[],this._dataProvider.forEach((function(t){e.push(t)}))),e},generateItems:function(e){var t=this._viewInstance.$data,a=this.safelyReadDataProvider(),r=this.generateItemsInternal(a);!0===e?(this.onUpdateView({add:!0,source:"remote",data:r}),t.asyncPush(r)):(this.onUpdateView({add:!0,source:"cache",data:r}),t.syncPush(r))},loadInitData:function(){var e=this,t=e._dataProvider;t.reset(),e._isLoadingData=!0;var r=e._dataParams,i=t.getFirstPage({data:d.extend({},r)});return(i=a.tojQueryDeferred(i)).always((function(){e._isInit=!1,e._isLoadingData=!1})),i.then((function(){var a=e._viewInstance.$data;a.clean(),a.hasMoreData(t.hasNextPage()),e.generateItems(!0)}))},renderData:function(e){var t=this._viewInstance.$data;t.clean(),t.hasMoreData(this._dataProvider.hasNextPage()),this.generateItems(!0===e)},refresh:function(e){var t=this._viewInstance.$data,r=this._viewInstance.$refresher;t.hasMoreData(!0),r.show(e);var i=this.loadInitData();return a.tojQueryDeferred(i).always((function(){r.hide(e)}))},loadMore:function(){var e=this,t=e._dataProvider,r=e._dataParams,i=e._viewInstance.$data,n=e._viewInstance.$moreLoader;if(e._isInit)return n.hide(),a.lift(!0,null);if(e._isLoadingData)return a.lift(!0,null);if(!t.hasNextPage())return i.hasMoreData(!1),n.hide(),a.lift(!0,null);n.show(),e._isLoadingData=!0;var s=t.getNextPage({data:d.extend({},r)}).then((function(){i.hasMoreData(t.hasNextPage()),e.generateItems(!0),e._isLoadingData=!1}),(function(){e._isLoadingData=!1}));return a.tojQueryDeferred(s).always((function(){n.hide()}))},stateChanged:function(){var e=this._stateContext;return!0!==e.enableSearch||e.searchModel.isConfirmed()&&e.searchModel.hashCode()!==e.searchCriteria.hashCode},updateStateAndReload:function(){var e=this._stateContext,t=this._viewInstance.$data,r=this._viewInstance.$loader;!0===e.enableSearch&&(e.searchCriteria=e.searchModel.generateFilter(),this.dataParams(e.searchCriteria.filter),t.updateSearchCriteria(e.searchCriteria)),r.show();var i=this.loadInitData();a.tojQueryDeferred(i).always((function(){r.hide()}))},setUp:function(e){if((e=e||{}).enableSearch){this._stateContext.enableSearch=!0;var t=e.searchSettings;this._stateContext.searchURL=t.searchURL,this._stateContext.searchModelGuid=t.searchModelGuid,this._stateContext.searchModel=t.searchModel,this._stateContext.searchCriteria=t.searchModel.generateFilter(),this.dataParams(this._stateContext.searchCriteria.filter)}},tearDown:function(){this._dataProvider&&this._dataProvider.off&&(this._dataProvider.off("all"),this._dataProvider.reset())},attachView:function(e){var t=this;t._viewInstance=e;var a=t._viewInstance.$data;t._enableRefresh&&a.setRefreshCallback((function(){t.refresh()})),t._enableInfinite&&a.setInfiniteCallback((function(){t.loadMore()})),t._stateContext.enableSearch&&a.setupSearch(t._stateContext.searchCriteria,(function(){t._viewInstance.$router.go(t._stateContext.searchURL,{dataId:t._stateContext.searchModelGuid})})),a.init()},detachView:function(){this._viewInstance=s},_defaultStartService:function(){var e=this._viewInstance.$loader;e.show();var t=this.loadInitData();a.tojQueryDeferred(t).always((function(){e.hide()}))},startServiceImpl:function(){this._defaultStartService()},startService:function(e,t){this.attachView(e),!0===t?this.renderData():this.startServiceImpl()},stopService:function(){this.detachView()}}),l=h.extend({init:function(e){this._super(e),this._ngStore=null},setNgStore:function(e){this._ngStore=e},getNgStore:function(){return this._ngStore},safelyReadDataProvider:function(){var e=this._super();return this._ngStore.add(e),e},renderData:function(e){var t=this,a=t._viewInstance.$data;a.clean(),a.hasMoreData(t._dataProvider.hasNextPage());var r=t._ngStore.getState().subscribe((function(i){var n=t.generateItemsInternal(i.items);!0===e?a.asyncPush(n):a.syncPush(n),setTimeout((function(){r.unsubscribe()}),1)}))}}),c=t.underscore,u=t.backbone,v=h.extend({Properties:"viewLevelData,globalProvider",init:function(e){this._super(e);var t=u.Collection.extend();this._viewLevelData=new t,this._viewProviderListeners={},this._globalProvider=e.globalProvider||null,this._globalProviderListeners={},this._filterFlags=e.filterFlags||{added:!0,removed:!0,updated:!0}},globalProviderFilter:function(e,t,a){return this._filterFlags.added&&t.changes.added&&t.changes.added.length>0||this._filterFlags.removed&&t.changes.removed&&t.changes.removed.length>0||this._filterFlags.updated&&t.changes.merged&&t.changes.merged.length>0?t:null},findAtIndex:function(e){return-1},onGlobalProviderUpdate:function(){var e=this,t=arguments;if(!e._isLoadingData){var a=e.globalProviderFilter.apply(e,t);if(a){if(a.add){var r=c.filter(a.changes.added,(function(t){return!c.some(e._viewLevelData.models,(function(e){return t.id===e.id}))}));r.length>0&&c.each(r,(function(t,a){var r=e.findAtIndex(t);-1!==r?e._viewLevelData.add(t,{at:r}):e._viewLevelData.add(t)}))}a.remove&&e._viewLevelData.remove(a.changes.removed),a.merge&&e._viewLevelData.trigger("update",a.changes)}}},onViewProviderUpdate:function(e,t,a){var r,i=this._viewInstance.$data;t.changes.added&&t.changes.added.length>0&&(r=this.generateItemsInternal(t.changes.added),this.onUpdateView({add:!0,source:"event",data:r}),i.asyncPrepend(r)),t.changes.removed&&t.changes.removed.length>0&&(r=this.generateItemsInternal(t.changes.removed),this.onUpdateView({remove:!0,source:"event",data:r}),i.asyncPop(r)),t.changes.merged&&t.changes.merged.length>0&&(r=this.generateItemsInternal(t.changes.merged),this.onUpdateView({merge:!0,source:"event",data:r}),i.asyncRefresh(r))},loadInitData:function(){return this._viewLevelData.reset(),this._super()},startListeningGlobalProvider:function(e){var t=this,a=function(){var e=arguments;c.defer((function(){t.onGlobalProviderUpdate.apply(t,e)}))};t._globalProviderListeners={update:a},t._globalProvider=e,e.on("update",a)},stopListeningGlobalProvider:function(){var e=this._globalProviderListeners,t=this._globalProvider;for(var a in e)e.hasOwnProperty(a)&&t.off(a,e[a])},startListeningViewProvider:function(){var e=this,t=function(t,a,r){e.onViewProviderUpdate(t,a,r)};e._viewProviderListeners={update:t},e._viewLevelData.on("update",t)},stopListeningViewProvider:function(){var e=this._viewProviderListeners;for(var t in e)e.hasOwnProperty(t)&&this._viewLevelData.off(t,e[t])},safelyReadDataProvider:function(){var e=this,t=e._super();return t=c.filter(t,(function(t){return!c.some(e._viewLevelData.models,(function(e){return e.id===t.id}))})),e._viewLevelData.add(t,{silent:!0}),t},renderData:function(e){var t=this._viewInstance.$data;t.clean(),t.hasMoreData(this._dataProvider.hasNextPage());var a=this.generateItemsInternal(this._viewLevelData.models);!0===e?t.asyncPush(a):t.syncPush(a)},setUp:function(e){this._super(e),this._globalProvider&&this.startListeningGlobalProvider(this._globalProvider)},tearDown:function(){this._super(),this._viewLevelData.off("all"),this._viewLevelData.reset(),this._globalProvider&&this.stopListeningGlobalProvider()},attachView:function(e){this._super(e),this.startListeningViewProvider()},detachView:function(){this._super(),this.stopListeningViewProvider()}});t.underscore;var f=v.extend({Properties:"globalSubr, emitEventDelay",init:function(e){this._super(e),this._globalSubr=null,this._emitEventDelay=1e3},startListeningGlobalProvider:function(e){var t=this;t._globalProvider=e;var n=r.fromEvent(e,"update"),s=n.pipe(i.debounceTime(t._emitEventDelay));t._globalSubr=n.pipe(i.buffer(s),i.map((function(e){var t;return t={add:!1,remove:!1,merge:!1,changes:{added:[],removed:[],merged:[]}},e.forEach((function(e){var r=e[1];r.changes.added&&r.changes.added.length>0&&(a.pushArray(t.changes.added,r.changes.added),t.add=!0),r.changes.removed&&r.changes.removed.length>0&&(a.pushArray(t.changes.removed,r.changes.removed),t.remove=!0),r.changes.merged&&r.changes.merged.length>0&&(a.pushArray(t.changes.merged,r.changes.merged),t.merge=!0)})),t}))).subscribe((function(e){t.onGlobalProviderUpdate.apply(t,[null,e])}))},stopListeningGlobalProvider:function(){this._globalProvider;this._globalSubr&&(this._globalSubr.unsubscribe(),this._globalSubr=null)}}),g=t.Class.extend({Defaults:{MediatorCtor:null},Properties:"mediator,settings",init:function(e){this._settings=e,this._isFirstTimeRendered=!0,this._mediator=e.mediator||null,this._mediatorFromCache=!!this._mediator},initMediator:function(){var e,t;return this,this._mediator||(e=this._settings,t=new(0,this.Defaults.MediatorCtor)(e),this.setupMediator(t),this._mediator=t),this},setupMediator:function(e){e.setUp()},start:function(){var e,t,a;t=(e=this)._settings,a=e._mediator,t.$render.destroy((function(){a.stopService()})),t.$render.ready((function(){e._isFirstTimeRendered&&(e._isFirstTimeRendered=!1,a.startService(t,e._mediatorFromCache))}))}});e.ListControllerCtor=g,e.ListMediator=h,e.NgStoreListMediator=l,e.RxjsPoweredWritableListMediator=f,e.WritableListMediator=v,e.noopViewInstance=s,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=polpware-fe-mvc.umd.min.js.map